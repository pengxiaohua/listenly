generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  wechatOpenId String?  @unique // 微信用户唯一ID
  phone        String?  @unique // 手机号登录
  createdAt DateTime @default(now())
  lastLogin DateTime @default(now())
}

model Word {
  id          String      @id @default(uuid())
  word        String
  phoneticUS    String
  phoneticUK    String
  definition  String
  translation String
  exchange    String?
  category    String      // 例如 "zk", "gk", "cet4", "cet6" 等
  records     WordRecord[]

  @@unique([word, category])
}

model WordRecord {
  id          String    @id @default(uuid())
  userId      String
  wordId      String
  isCorrect   Boolean   @default(false)
  errorCount  Int       @default(0)
  lastAttempt DateTime  @default(now())
  createdAt   DateTime  @default(now())

  word        Word      @relation(fields: [wordId], references: [id])

  @@unique([userId, wordId])
}

// 用户反馈
model Feedback {
  id        String   @id @default(uuid())
  userId    String   // 用户ID（可以扩展为 OAuth 用户）
  title     String   @db.VarChar(20)
  content   String   @db.VarChar(200)
  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model DictationProgress {
  id        String   @id @default(cuid())
  userId    String
  lrcFile   String   // 歌词文件路径
  position  Int      // 当前句子位置
  attempts  Json     // 存储每句的尝试记录 [{sentence: string, userInput: string, correct: boolean}]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, lrcFile])
}

model SmsCode {
  id        String   @id @default(uuid())
  phone     String   @unique
  code      String
  expiresAt DateTime
  createdAt DateTime @default(now())
}

/// 语料库表
model Corpus {
  id          Int        @id @default(autoincrement())
  /// 语料库英文名（如 common100），用于显示
  name        String     @unique
  /// OSS文件夹名称
  ossDir      String     @unique
  /// 语料库中文描述
  description String?
  /// 创建时间
  createdAt   DateTime   @default(now())
  /// 更新时间
  updatedAt   DateTime   @updatedAt
  sentences   Sentence[]
  userProgress UserProgress[]
}

/// 句子表
model Sentence {
  id        Int      @id @default(autoincrement())
  /// 所属语料库ID
  corpusId  Int
  /// 在语料库中的序号（从0或1开始均可）
  index     Int
  /// 英文句子内容
  text      String
  /// 中文翻译
  translation String?
  corpus    Corpus   @relation(fields: [corpusId], references: [id])
  sentenceRecords SentenceRecord[]
}

/// 用户进度表
model UserProgress {
  id            Int      @id @default(autoincrement())
  /// 用户ID
  userId        String
  /// 语料库ID
  corpusId      Int
  /// 当前进度（句子index）
  sentenceIndex Int
  /// 更新时间
  updatedAt     DateTime @updatedAt

  corpus Corpus @relation(fields: [corpusId], references: [id])

  @@unique([userId, corpusId])
}

/// 用户句子练习记录表
model SentenceRecord {
  id         Int      @id @default(autoincrement())
  /// 用户ID
  userId     String
  /// 句子ID
  sentenceId Int
  /// 用户输入内容
  userInput  String
  /// 是否正确
  correct    Boolean
  /// 错误次数
  errorCount Int      @default(0)
  /// 答题时间
  createdAt  DateTime @default(now())

  sentence Sentence @relation(fields: [sentenceId], references: [id])
}
